<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿„ç¾…æ–¯è¼ªç›¤ - é›²ç«¯ç«¶æŠ€ç‰ˆ</title>
    <style>
        :root { --hb-speed: 1.8s; --pulse-color: rgba(255,0,0,0.15); --main-red: #b30000; --gold: #ffcc00; }
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 20px auto; background: #1a1a1a; padding: 30px; border-radius: 15px; border: 2px solid #333; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 5; transition: 0.3s; }
        h1 { color: var(--main-red); letter-spacing: 5px; text-shadow: 2px 2px 5px #000; margin: 30px 0 10px 0; }
        .bounty-display { font-size: 2.5em; color: var(--gold); font-weight: bold; margin: 20px 0; }
        
        #account-bar { font-size: 0.85em; color: #888; margin-bottom: 10px; cursor: pointer; background: #222; padding: 8px; border-radius: 5px; border: 1px solid #333; }
        #account-bar:hover { border-color: var(--gold); color: #fff; }
        
        button { padding: 12px; font-size: 1em; cursor: pointer; border-radius: 8px; border: none; width: 95%; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn-shoot { background: var(--main-red); color: #fff; border-bottom: 4px solid #600; }
        .btn-cashout { background: #008000; color: #fff; border-bottom: 4px solid #004000; }
        .btn-menu { background: #333; color: #eee; border: 1px solid #444; }
        .btn-sync { background: var(--gold); color: #000; font-size: 0.9em; }
        
        .module-list { max-height: 400px; overflow-y: auto; padding-right: 5px; margin: 15px 0; }
        .module-card { background: #222; border: 1px solid #333; padding: 15px; margin: 8px 0; border-radius: 10px; text-align: left; cursor: pointer; transition: 0.2s; }
        .module-card:hover { border-color: var(--gold); background: #2a2400; }
        .module-title { color: var(--gold); font-weight: bold; display: block; margin-bottom: 5px; }
        .module-info { color: #aaa; font-size: 0.85em; font-family: monospace; word-break: break-all; }

        .lb-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; background: #222; font-size: 0.8em; cursor: pointer; border-radius: 5px; border: 1px solid #444; }
        .tab.active { background: var(--gold); color: #000; border-color: var(--gold); }
        .lb-list { background: #000; border-radius: 8px; padding: 10px; min-height: 250px; overflow-y: auto; max-height: 400px; }
        .lb-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; font-size: 0.9em; align-items: center; }
        .lb-rank { width: 35px; color: var(--gold); font-weight: bold; text-align: left; }
        .lb-name { flex: 1; text-align: left; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .lb-val { color: #fff; font-family: monospace; font-weight: bold; }
        .me { background: rgba(255, 204, 0, 0.15) !important; border-radius: 4px; }
        
        .scene { display: none; }
        .active { display: block; }
        .nav-btn { position: absolute; top: 15px; background: #333; color: var(--gold); padding: 6px 12px; border-radius: 5px; font-size: 0.8em; cursor: pointer; border: 1px solid #444; z-index: 10; }
        #fx-layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 100; }
        .flash { animation: flash-anim 0.12s forwards; }
        @keyframes flash-anim { 0% { background: #fff; opacity: 1; } 100% { opacity: 0; } }
        
        .odds-panel { background: #000; border: 1px dashed #444; padding: 10px; margin: 15px 0; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em; }
        .odds-item { text-align: left; }
        .odds-label { color: #888; display: block; font-size: 0.8em; }
        .odds-value { color: #fff; font-weight: bold; }

        #hp-display { font-size: 1.5em; margin-bottom: 10px; color: #ff4444; text-shadow: 0 0 10px rgba(255,0,0,0.5); }
        .last-life-warn { color: #ff0000; font-size: 0.7em; font-weight: bold; animation: blink 1s infinite; display: none; }
        
        /* ç¦å¿Œæ¨¡å¼æ•ˆæœ */
        .void-mode { border-color: #ff0000 !important; box-shadow: 0 0 50px rgba(255,0,0,0.8) !important; animation: void-pulse 0.5s infinite alternate !important; }
        @keyframes void-pulse { from { box-shadow: 0 0 20px rgba(255,0,0,0.4); } to { box-shadow: 0 0 60px rgba(255,0,0,1); } }
        
        #void-label { color: #ff0000; font-weight: bold; letter-spacing: 2px; display: none; animation: blink 0.2s infinite; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #ach-list-container { max-height: 380px; overflow-y: auto; padding-right: 5px; margin: 10px 0; }
        .ach-card { cursor: pointer; position: relative; transition: 0.2s; }
        .ach-card:hover { transform: scale(1.02); }
        .ach-equipped { border: 2px solid var(--gold) !important; box-shadow: 0 0 10px rgba(255, 204, 0, 0.3); }
        .equip-tag { position: absolute; top: 5px; right: 10px; font-size: 0.7em; color: var(--gold); font-weight: bold; }

        .effect-million { color: #ffff00 !important; text-shadow: 0 0 8px #ffff00; }
        .effect-ten-million { color: #ff8c00 !important; text-shadow: 0 0 8px #ff8c00; }
        .effect-hundred-million { color: #00ffff !important; text-shadow: 0 0 8px #00ffff; }
        .effect-lucky { color: #00ff00 !important; text-shadow: 0 0 8px #00ff00; }
        .effect-life-death { background: linear-gradient(90deg, #ff4500, #ff0000); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255, 69, 0, 0.8)); }
        .effect-limit { background: linear-gradient(90deg, #1e90ff, #8a2be2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(138, 43, 226, 0.8)); }
        .effect-unlucky-son { background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff); background-size: 400% 400%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow-flow 3s linear infinite, glow-pulse 1.5s ease-in-out infinite; }
        @keyframes rainbow-flow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes glow-pulse { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3) drop-shadow(0 0 8px rgba(255,255,255,0.8)); } }
    </style>
</head>
<body onload="init()">
    <div id="fx-layer"></div>
    <div class="container" id="main-container">
        <div id="nav-group">
            <div class="nav-btn" style="left:15px" onclick="changeScene('ach-scene')">ğŸ† æˆå°±</div>
            <div class="nav-btn" style="right:15px" onclick="changeScene('lb-scene')">ğŸ¥‡ æ¦œå–®</div>
        </div>

        <div id="menu-scene" class="scene active">
            <h1>RUSSIAN<br>ROULETTE</h1>
            
            <div id="account-bar" onclick="changeScene('acc-scene')">
                ğŸ‘¤ <span id="acc-status">æœªç™»å…¥ (é»æ“Šç™»å…¥æˆ–å‰µå»ºå¸³è™Ÿ)</span>
                <span id="equipped-icon-main"></span>
            </div>

            <div style="background: #222; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 5px solid var(--gold); text-align: left;">
                <div style="margin-bottom: 12px;"><div style="color: #888; font-size: 0.75em;">TOTAL ASSETS</div><div style="font-size: 1.8em; font-weight: bold; color: var(--gold);">$<span id="total-money">0</span></div></div>
                <div><div style="color: #888; font-size: 0.75em;">PEAK RECORD</div><div style="font-size: 1.2em; font-weight: bold; color: #eee;">$<span id="peak-money">0</span></div></div>
            </div>
            <button class="btn-menu" style="background:var(--main-red); color:#fff;" onclick="startGame()">é€²å…¥è³­å±€</button>
            <button class="btn-sync" id="sync-btn" onclick="syncToCloud()">â˜ï¸ åŒæ­¥æ•¸æ“šè‡³é›²ç«¯</button>
        </div>

        <div id="acc-scene" class="scene">
            <h2>ACCOUNT CENTER</h2>
            <div class="module-list">
                <div class="module-card">
                    <span class="module-title">1. å¸³è™Ÿè³‡è¨Š (åŸºæœ¬è³‡æ–™)</span>
                    <div class="module-info" onclick="rename()">æš±ç¨±ï¼š<span id="acc-nick" style="color:#fff">--</span> (é»æ“Šä¿®æ”¹)</div>
                    <div class="module-info" onclick="editLegacyKey()">ç¹¼æ‰¿ç¢¼ï¼š<span id="acc-key" style="color:#fff">--</span> (é»æ“Šä¿®æ”¹)</div>
                    <div class="module-info">UIDï¼š<span id="acc-uid" style="color:#777">--</span></div>
                </div>

                <div class="module-card" onclick="openInheritMode('normal')">
                    <span class="module-title">2. å¸³è™Ÿç¹¼æ‰¿ (æ­£å¼é·ç§»)</span>
                    <div class="module-info">è¼¸å…¥ UID èˆ‡ç¹¼æ‰¿ç¢¼ï¼Œå¾å…¶ä»–è£ç½®é ˜å›å®Œæ•´è³‡ç”¢ã€‚</div>
                </div>
            </div>
            <button class="btn-menu" onclick="changeScene('menu-scene')">è¿”å›</button>
        </div>

        <div id="game-scene" class="scene">
            <div id="hp-display">â¤ï¸â¤ï¸â¤ï¸</div>
            <div id="void-label">ä½ ä¸è©²ä¾†é€™è£¡......</div>
            <div id="last-life-label" class="last-life-warn">âš ï¸ LAST CHANCE: 2X BOUNTY ACTIVE âš ï¸</div>
            <div class="bounty-display">$<span id="current-bounty">0</span></div>
            <div class="odds-panel" id="odds-box">
                <div class="odds-item"><span class="odds-label">ç”Ÿå­˜æ©Ÿç‡</span><span class="odds-value" id="stat-survival">--</span></div>
                <div class="odds-item"><span class="odds-label">æˆåŠŸæ”¶ç›Š</span><span class="odds-value" id="stat-gain" style="color: var(--gold);">--</span></div>
            </div>
            <div id="log">> æº–å‚™å¥½è³­ä¸Šä¸€åˆ‡äº†å—ï¼Ÿ</div>
            <div style="margin: 20px 0;">
                <span style="font-size:0.8em; color:#888;">è£å¡«å­å½ˆ (1-6):</span><br>
                <input type="text" id="bullet-input" value="1" oninput="updateOdds()" style="background:#000; color:#fff; border:1px solid #ff4444; padding:10px; width:60px; text-align:center; border-radius:5px; font-size:1.2em; margin-top:5px;">
            </div>
            <button class="btn-shoot" id="shoot-btn" onclick="playTurn()">æ‰£ä¸‹æ¿æ©Ÿ</button>
            <button class="btn-cashout" id="cash-btn" onclick="handleCashOut()">è¦‹å¥½å°±æ”¶</button>
        </div>

        <div id="lb-scene" class="scene">
            <h2>LEADERBOARD</h2>
            <div class="lb-tabs"><div id="tab-total" class="tab active" onclick="switchLB('total')">è²¡å¯Œç¸½æ¦œ</div><div id="tab-peak" class="tab" onclick="switchLB('peak')">å·”å³°å–®å±€</div></div>
            <div class="lb-list" id="lb-container">è¼‰å…¥ä¸­...</div>
            <button class="btn-menu" onclick="changeScene('menu-scene')">è¿”å›</button>
        </div>

        <div id="ach-scene" class="scene">
            <h2>ACHIEVEMENTS</h2>
            <div id="ach-list-container"></div>
            <button class="btn-menu" onclick="changeScene('menu-scene')">è¿”å›</button>
        </div>

        <div id="result-scene" class="scene">
            <h2 id="result-title"></h2>
            <div id="result-desc" style="margin: 20px 0; line-height:1.6;"></div>
            <button class="btn-menu" onclick="changeScene('menu-scene')">å›é¸å–®</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBH75KFH3Qp6A3hLbA--cOq-S9R-uE68Us",
            authDomain: "test123-4d385.firebaseapp.com",
            databaseURL: "https://test123-4d385-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test123-4d385",
            storageBucket: "test123-4d385.firebasestorage.app",
            messagingSenderId: "958147628261",
            appId: "1:958147628261:web:07de2a319eab92b92b980c",
            measurementId: "G-X19BVWZWVW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let userId = localStorage.getItem('roulette_uid') || 'U' + Math.random().toString(36).substr(2, 7).toUpperCase();
        localStorage.setItem('roulette_uid', userId);

        window.state = { 
            name: "åŒ¿åç©å®¶", 
            legacy_key: Math.random().toString(36).substr(2, 6).toUpperCase(),
            total: 0, peak: 0, peak_time: 0, 
            deaths: 0, cashout_count: 0,
            achs: new Array(12).fill(0), title_index: -1 
        };
        
        let curBounty = 0;
        let playerHp = 3;
        let unluckyTrack = 0;

        const ACH_DATA = [
            { title: "åˆç”Ÿä¹‹çŠ¢", icon: "ğŸ”°", desc: "å®Œæˆç¬¬ä¸€æ¬¡ã€Œæ­¢æé ˜éŒ¢ã€ã€‚" },
            { title: "è³­å¾’æœ¬è‰²", icon: "ğŸ²", desc: "å–®å±€è³é‡‘çªç ´ $10,000ã€‚" },
            { title: "å¼·é‹çš„è¿´éŸ¿", icon: "ğŸ€", desc: "6 é¡†å­å½ˆä¸‹è§¸ç™¼ 1% å¡æ®¼æˆåŠŸç”Ÿå­˜ã€‚", secret: true, effect: "effect-lucky" },
            { title: "ç™¾è¬å¯Œç¿", icon: "ğŸ’µ", desc: "ç”Ÿæ¶¯ç´¯ç©ç¸½è³é‡‘é” $1,000,000ã€‚", effect: "effect-million" },
            { title: "ä¹æ­»ä¸€ç”Ÿ", icon: "ğŸ•¯ï¸", desc: "åœ¨è£å¡« 5 é¡†å­å½ˆé›£åº¦ä¸‹å­˜æ´»ä¸€æ¬¡ã€‚" },
            { title: "ï¼ˆå·²ç§»é™¤ï¼‰", icon: "âŒ", desc: "æ­¤æˆå°±å·²å°å°ã€‚", hidden: true }, 
            { title: "åƒè¬å¯Œç¿", icon: "ğŸ’°", desc: "ç”Ÿæ¶¯ç´¯ç©ç¸½è³é‡‘é” $10,000,000ã€‚", effect: "effect-ten-million" },
            { title: "å„„è¬å¯Œç¿", icon: "ğŸ’", desc: "ç”Ÿæ¶¯ç´¯ç©ç¸½è³é‡‘é” $100,000,000ã€‚", effect: "effect-hundred-million" },
            { title: "æ»¿è¼‰è€Œæ­¸", icon: "ğŸ˜", desc: "å–®æ¬¡ã€Œè¦‹å¥½å°±æ”¶ã€é ˜å–è¶…é 10 è¬è³é‡‘ã€‚", effect: "effect-lucky" },
            { title: "è¶…è¶Šç”Ÿæ­»", icon: "ğŸ¦â€ğŸ”¥", desc: "æ–¼ä¸€æ»´è¡€ç‹€æ…‹è§¸ç™¼ 6 å½ˆå¡æ®¼ã€‚", secret: true, effect: "effect-life-death" },
            { title: "è¶…è¶Šæ¥µé™", icon: "â™¾ï¸", desc: "åœ¨ç¦å¿Œçš„ 7 å½ˆæ¨¡å¼ä¸­å¥‡è¹Ÿç”Ÿé‚„ã€‚", secret: true, effect: "effect-limit" },
            { title: "æ£„é‹ä¹‹å­", icon: "âš¡ï¸", desc: "æ»¿è¡€æ™‚ä»¥ 1 å½ˆé€£æŠ½å¤±æ•—æ‰£è¡€ç›´è‡³æ­»äº¡ã€‚", secret: true, effect: "effect-unlucky-son" }
        ];

        window.init = function() {
            const saved = localStorage.getItem('roulette_pro_save');
            if (saved) {
                const parsed = JSON.parse(saved);
                if(!parsed.legacy_key) parsed.legacy_key = Math.random().toString(36).substr(2, 6).toUpperCase();
                while(parsed.achs.length < ACH_DATA.length) parsed.achs.push(0);
                window.state = parsed;
            }
            updateUI();
            updateOdds();
            loadLeaderboardListener();
        };

        window.saveLocal = function() { localStorage.setItem('roulette_pro_save', JSON.stringify(window.state)); };

        window.rename = function() {
            const n = prompt("è¼¸å…¥æ–°æš±ç¨±ï¼š", window.state.name);
            if (n) {
                window.state.name = n.trim().substring(0, 16);
                saveLocal(); updateUI();
            }
        };

        window.openInheritMode = function(type) {
    if (type === 'normal') {
        const targetNick = prompt("ã€æ•‘æ´æ¨¡å¼ã€‘è«‹è¼¸å…¥æ‚¨çš„èˆŠæš±ç¨±ï¼š");
        const targetKey = prompt("ã€æ•‘æ´æ¨¡å¼ã€‘è«‹è¼¸å…¥æ‚¨çš„ç¹¼æ‰¿ç¢¼ï¼š");
        
        if (!targetNick || !targetKey) return;

        console.log("æ­£åœ¨é›²ç«¯æœå°‹ç©å®¶...");
        // å–å¾—æ‰€æœ‰ç©å®¶è³‡æ–™é€²è¡Œæ¯”å°
        onValue(ref(db, 'players'), (snap) => {
            const allData = snap.val();
            let foundUid = null;
            let foundData = null;

            if (allData) {
                for (let uid in allData) {
                    // åŒæ™‚æ¯”å° æš±ç¨± èˆ‡ ç¹¼æ‰¿ç¢¼
                    if (allData[uid].name === targetNick && allData[uid].l_key === targetKey) {
                        foundUid = uid;
                        foundData = allData[uid];
                        break;
                    }
                }
            }

            if (foundUid && foundData) {
                if(confirm(`æˆåŠŸæ‰¾åˆ°ç©å®¶ï¼\nUID: ${foundUid}\nè³‡ç”¢: $${foundData.total.toLocaleString()}\nç¢ºå®šè¦æ‰¾å›æ­¤å¸³è™Ÿå—ï¼Ÿ`)) {
                    applyInherit(foundData, foundUid);
                }
            } else {
                alert("é©—è­‰å¤±æ•—ï¼šæ‰¾ä¸åˆ°ç¬¦åˆè©²æš±ç¨±èˆ‡ç¹¼æ‰¿ç¢¼çš„å¸³è™Ÿã€‚");
            }
        }, { onlyOnce: true });
    }
};

        function applyInherit(data, oldUid) {
            window.state.total = data.total || 0;
            window.state.peak = data.peak || 0;
            window.state.name = data.name;
            window.state.achs = data.achs || window.state.achs;
            window.state.title_index = data.t_idx !== undefined ? data.t_idx : -1;
            saveLocal();
            set(ref(db, 'players/' + userId), { ...data, last_sync: Date.now() });
            if(oldUid !== userId) remove(ref(db, 'players/' + oldUid));
            updateUI();
            alert("ç¹¼æ‰¿æˆåŠŸï¼æ•¸æ“šå·²åŒæ­¥ã€‚");
            changeScene('menu-scene');
        }

        window.changeScene = function(sId) {
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            document.getElementById(sId).classList.add('active');
            document.getElementById('nav-group').style.display = (sId === 'menu-scene') ? 'block' : 'none';
            if (sId === 'ach-scene') renderAchievements();
            updateUI();
        };

        window.startGame = function() {
            playerHp = 3; curBounty = 0; unluckyTrack = 0;
            document.getElementById('log').innerHTML = "> æº–å‚™å¥½è³­ä¸Šä¸€åˆ‡äº†å—ï¼Ÿ";
            document.getElementById('bullet-input').value = 1;
            changeScene('game-scene');
            updateUI(); updateOdds();
        };

        window.updateOdds = function() {
            let bInput = document.getElementById('bullet-input');
            let rawVal = bInput.value;
            
            let b = parseInt(rawVal);
            if (isNaN(b)) b = 0; 

            let survDisplay = document.getElementById('stat-survival');
            let gainDisplay = document.getElementById('stat-gain');
            let container = document.getElementById('main-container');
            let voidLabel = document.getElementById('void-label');
            
            if (b === 7 && window.state.achs[2] === 1) {
                container.classList.add('void-mode');
                voidLabel.style.display = 'block';
                survDisplay.innerText = "???"; gainDisplay.innerText = "???";
            } else {
                container.classList.remove('void-mode');
                voidLabel.style.display = 'none';
                
                // è¶…å‡º 1-6 çš„ç¯„åœé¡¯ç¤ºç‚º --
                if (b < 1 || b > 6) {
                    survDisplay.innerText = "--";
                    gainDisplay.innerText = "--";
                } else {
                    let survivalRate = ((6 - b) / 6 * 100).toFixed(1);
                    let potentialGain = Math.pow(b, 2) * 250;
                    if (b === 6) { survivalRate = "1.0"; potentialGain = 77777; }
                    if (playerHp === 1) potentialGain *= 2;
                    survDisplay.innerText = (b===6?"1.0%":survivalRate + "%");
                    gainDisplay.innerText = "+$" + potentialGain.toLocaleString();
                }
            }
            updateHpDisplay(b);
        };

        window.playTurn = function() {
            let bInput = document.getElementById('bullet-input');
            let b = parseInt(bInput.value);

            // å¦‚æœè¼¸å…¥ 7 ä½†æ²’æœ‰è§£é–å¼·é‹ï¼Œæˆ–è€…è¼¸å…¥å¤§æ–¼ 7 æˆ–å°æ–¼ 1ï¼Œåˆ¤å®šç‚ºéæ³•
            // æç¤ºå§‹çµ‚åªé¡¯ç¤º 1-6
            let isSevenAllowed = (b === 7 && window.state.achs[2] === 1);
            if (isNaN(b) || b < 1 || (b > 6 && !isSevenAllowed)) {
                alert("ç„¡æ•ˆçš„è£å¡«é‡ï¼è«‹è¼¸å…¥ 1-6 ä¹‹é–“çš„æ•¸å­—ã€‚");
                bInput.value = 1;
                updateOdds();
                return;
            }

            flashEffect();

            if (playerHp === 3 && curBounty === 0 && b === 1) unluckyTrack = 1;
            else if (b !== 1) unluckyTrack = 0; 

            if (b === 7) {
                if (Math.random() < 0.00007) {
                    let gain = 7777777;
                    curBounty += gain; 
                    window.state.achs[10] = 1;
                    document.getElementById('log').innerHTML = "<b style='color:#ff0000'>ğŸ‘ï¸ ç¥‚åœ¨çœ‹è‘—ä½ ã€‚ç²å¾— $7,777,777</b>";
                } else { 
                    playerHp = 0; 
                    window.state.deaths++; 
                    if(unluckyTrack === 1) window.state.achs[11] = 1;
                    saveLocal(); 
                    showResult(false); 
                }
                updateUI(); return;
            }

            let multiplier = (playerHp === 1) ? 2 : 1;
            
            if (b === 6 && Math.random() < 0.01) {
                window.state.achs[2] = 1; 
                if (playerHp === 1) window.state.achs[9] = 1;
                let gain = 77777 * multiplier;
                curBounty += gain;
                document.getElementById('log').innerHTML = "<b style='color:#ffcc00'>ğŸ° å¥‡è¹Ÿå¡æ®¼ï¼</b>";
            } else if (Math.random() * 6 < b) {
                playerHp--;
                if (playerHp <= 0) { 
                    if(unluckyTrack === 1) window.state.achs[11] = 1;
                    window.state.deaths++; saveLocal(); showResult(false); 
                }
                else document.getElementById('log').innerHTML = "<b style='color:#ff4444'>ğŸ’¥ æ“Šç™¼å¤±æ•—ï¼ç”Ÿå‘½ -1</b>";
            } else {
                unluckyTrack = 0; 
                let gain = (Math.pow(b, 2) * 250 * multiplier);
                curBounty += gain;
                if (b === 5) window.state.achs[4] = 1;
                document.getElementById('log').innerText = `> æ“Šç™¼æˆåŠŸã€‚ç•¶å‰ï¼š$${curBounty.toLocaleString()}`;
            }
            updateUI(); updateOdds();
        };

        window.handleCashOut = function() {
            if (curBounty <= 0) return;
            
            if (curBounty >= 100000) window.state.achs[8] = 1; 
            if (curBounty >= 10000) window.state.achs[1] = 1; // è³­å¾’æœ¬è‰²

            window.state.total += curBounty;
            window.state.cashout_count++;
            
            if (curBounty > window.state.peak) { window.state.peak = curBounty; window.state.peak_time = Date.now(); }
            
            window.state.achs[0] = 1; 
            if (window.state.total >= 1000000) window.state.achs[3] = 1;
            if (window.state.total >= 10000000) window.state.achs[6] = 1;
            if (window.state.total >= 100000000) window.state.achs[7] = 1;
            
            saveLocal(); showResult(true);
        };

        window.syncToCloud = async function() {
            const btn = document.getElementById('sync-btn');
            btn.disabled = true; btn.innerText = "ğŸ›°ï¸ åŒæ­¥ä¸­...";
            try {
                await set(ref(db, 'players/' + userId), { 
                    name: window.state.name, 
                    total: window.state.total, 
                    peak: window.state.peak, 
                    l_key: window.state.legacy_key, 
                    t_idx: window.state.title_index, 
                    achs: window.state.achs, 
                    peak_time: window.state.peak_time || Date.now()
                });
                btn.innerText = "âœ… åŒæ­¥æˆåŠŸ";
                setTimeout(() => { btn.innerText = "â˜ï¸ åŒæ­¥æ•¸æ“šè‡³é›²ç«¯"; btn.disabled = false; }, 2000);
            } catch (e) { alert("åŒæ­¥å¤±æ•—ï¼"); btn.innerText = "âŒ å¤±æ•—"; btn.disabled = false; }
        };

        function loadLeaderboardListener(field = 'total') {
            const lbRef = query(ref(db, 'players'), orderByChild(field), limitToLast(20));
            onValue(lbRef, (snap) => {
                const data = snap.val();
                if (!data) return;
                const sorted = Object.values(data).sort((a,b) => b[field] - a[field]);
                document.getElementById('lb-container').innerHTML = sorted.map((p, i) => {
                    const titleIdx = p.t_idx;
                    const hasEffect = titleIdx >= 0 && ACH_DATA[titleIdx].effect;
                    const icon = titleIdx >= 0 ? ACH_DATA[titleIdx].icon : "";
                    return `
                    <div class="lb-row ${p.name === window.state.name ? 'me' : ''}">
                        <div class="lb-rank">#${i+1}</div>
                        <div class="lb-name ${hasEffect ? ACH_DATA[titleIdx].effect : ''}">${icon} ${p.name}</div>
                        <div class="lb-val">$${(p[field] || 0).toLocaleString()}</div>
                    </div>`;
                }).join("");
            });
        }

        window.switchLB = function(t) {
            document.getElementById('tab-total').className = t==='total'?'tab active':'tab';
            document.getElementById('tab-peak').className = t==='peak'?'tab active':'tab';
            loadLeaderboardListener(t);
        };

        function updateUI() {
            document.getElementById('total-money').innerText = window.state.total.toLocaleString();
            document.getElementById('peak-money').innerText = window.state.peak.toLocaleString();
            document.getElementById('current-bounty').innerText = curBounty.toLocaleString();
            
            const nameMain = document.getElementById('acc-status');
            nameMain.innerText = `ä½¿ç”¨è€…ï¼š${window.state.name}`;
            nameMain.className = "";
            if (window.state.title_index >= 0 && ACH_DATA[window.state.title_index].effect) {
                nameMain.classList.add(ACH_DATA[window.state.title_index].effect);
            }
            document.getElementById('equipped-icon-main').innerText = window.state.title_index>=0 ? ACH_DATA[window.state.title_index].icon : "";
            
            document.getElementById('acc-nick').innerText = window.state.name;
            document.getElementById('acc-key').innerText = window.state.legacy_key;
            document.getElementById('acc-uid').innerText = userId;
            document.getElementById('last-life-label').style.display = (playerHp === 1) ? "block" : "none";
        }

        window.renderAchievements = function() {
            const container = document.getElementById('ach-list-container');
            container.innerHTML = ACH_DATA.map((ach, i) => {
                if (ach.hidden) return ""; 
                const unlocked = window.state.achs[i] === 1;
                const equipped = window.state.title_index === i;
                if (ach.secret && !unlocked) return `<div class="ach-card" style="opacity:0.3; padding:15px; margin:8px; background:#222; border-radius:10px;">ğŸ”’ éš±è—æˆå°±</div>`;
                return `<div class="ach-card ${equipped ? 'ach-equipped' : ''}" onclick="toggleEquip(${i})" 
                             style="background:${unlocked?'#2a2400':'#222'}; padding:15px; margin:8px; border-radius:10px; text-align:left; border:1px solid #333;">
                             ${equipped?'<span class="equip-tag">é…æˆ´ä¸­</span>':''}
                             <b class="${unlocked?ach.effect:''}" style="color:${unlocked?'var(--gold)':'#555'}">${ach.title} ${ach.icon}</b><br>
                             <small style="color:#888">${ach.desc}</small>
                        </div>`;
            }).join("");
        };

        window.toggleEquip = function(i) {
            if(window.state.achs[i]!==1) return;
            window.state.title_index = window.state.title_index===i?-1:i;
            saveLocal(); renderAchievements(); updateUI();
        };

        function updateHpDisplay(bullets) {
            let b = bullets || parseInt(document.getElementById('bullet-input').value);
            if (b === 7 && window.state.achs[2] === 1) {
                document.getElementById('hp-display').innerText = "ğŸ’€ğŸ’€ğŸ’€";
            } else {
                document.getElementById('hp-display').innerText = "â¤ï¸".repeat(playerHp) + "ğŸ–¤".repeat(3-playerHp);
            }
        }

        function flashEffect() {
            const fx = document.getElementById('fx-layer');
            fx.classList.remove('flash'); void fx.offsetWidth; fx.classList.add('flash');
        }

        function showResult(win) {
            changeScene('result-scene');
            const t = document.getElementById('result-title');
            t.innerText = win ? "æ­¢ææˆåŠŸ" : "å‘½é‹çµ‚çµ";
            t.style.color = win ? "#0f0" : "#f00";
            document.getElementById('result-desc').innerText = win ? `é ˜èµ° $${curBounty.toLocaleString()}` : "æ­¸é›¶ã€‚";
            curBounty = 0;
        }
    </script>
</body>
</html>
